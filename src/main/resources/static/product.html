<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>

    <script src="https://unpkg.com/vue"></script>
    <script src="https://unpkg.com/vue-material@0.7.1"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.3/require.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/vue-material@0.7.1/dist/vue-material.css">


</head>
<body>

<script>

    Vue.use(VueMaterial)

</script>


<!--  ------------------------------------  컴포넌트 선언 영역입니다. 분리 예정입니다  -----------------------------------------   -->


<!--------- object grid 선언 (파일 분리 예정) ----------->

<script type="text/x-template" id="object-grid-template">

    <md-table v-once>
        <md-table-header>
            <md-table-row>
                <md-table-head v-for="key in columns"
                               :md-sort-by="key.name">
                    {{ key.displayName | capitalize }}
                </md-table-head>
            </md-table-row>
        </md-table-header>
        <md-table-body>
            <md-table-row v-for="entry in data">
                <md-table-cell v-for="key in columns">
                    {{ showValue(key, entry) }}
                </md-table-cell>
            </md-table-row>
        </md-table-body>
    </md-table>
</script>


<script>

    Vue.component('object-grid', {
        template: '#object-grid-template',
        props: {
            data: Array,
            columns: Array,
            filterKey: String,
            java: String,
            columnChanger: Object

        },

        created: function () {
            var xhr = new XMLHttpRequest()
            var self = this
            xhr.open('GET', "http://localhost:8080/metadata?className=" + this.java, false);
            xhr.onload = function () {
                var metadata = JSON.parse(xhr.responseText)
                self.columns = metadata.fieldDescriptors;

                if(self.columnChanger){
                    self.columnChanger(self.columns);
                }
            }
            xhr.send();

            this.loadData();

        },

        filters: {
            capitalize: function (str) {
                return str.charAt(0).toUpperCase() + str.slice(1)
            },


        },
        methods: {
            loadData: function(){
                ///loads the data firstly

                var pathElements = this.java.split(".");
                var path = pathElements[pathElements.length-1].toLowerCase();
                var xhr = new XMLHttpRequest()
                var self = this

                xhr.open('GET', "http://localhost:8080/" + path, false);

                xhr.onload = function () {
                    var jsonData = JSON.parse(xhr.responseText)
                    self.data = jsonData._embedded[path];
                }
                xhr.send();
            },
            sortBy: function (key) {
                this.sortKey = key
                this.sortOrders[key] = this.sortOrders[key] * -1
            },

            showValue: function(key, entry){
                if(key.computed){
                    return key.computed(entry);
                }else
                    return entry[key.name];
            },

            addRow: function(aRow){
               // this.rows.push(aRow);
                this.$forceUpdate();
                this.loadData();
            },
            removeRow: function(row){
                //console.log(row);
                this.rows.$remove(row);
            },
            onEvent: function(event, data){
                if(event == "saved"){
                    this.addRow(data);
                }
            }
        }
    })
</script>



<!----   object form 부분 (다른 파일로 분리 예정) ----->

<script type="text/x-template" id="object-form-template">
    <form novalidate @submit.stop.prevent="submit" v-once>
        <md-input-container v-for="key in columns">
            <label>{{ key.displayName }}</label>
            <md-input v-model="data[key.name]" :type="key.type"></md-input>
        </md-input-container>

        <md-button class="md-raised md-primary" v-on:click.native="submit_">Submit</md-button>
    </form>
</script>


<script>

    Vue.component('object-form', {
        template: '#object-form-template',
        props: {
            columns: Array,
            java: String,
            data: Object,
            eventListeners: Array

        },

        created: function () {
            var xhr = new XMLHttpRequest()
            var self = this
            xhr.open('GET', "http://localhost:8080/metadata?className=" + this.java, false);
            xhr.onload = function () {
                var metadata = JSON.parse(xhr.responseText)
                self.columns = metadata.fieldDescriptors;

                self.columns.forEach(function(item){
                    if(item.className == "long" || item.className == "java.lang.Long" || item.className == "java.lang.Integer"){
                        item.type = "number";
                    }else if(item.className == "java.util.Date" || item.className == "java.util.Calendar"){
                        item.type = "date";
                    }

                });
            }
            xhr.send();

        },

        methods:{
            submit_: function(){

                var pathElements = this.java.split(".");
                var path = pathElements[pathElements.length-1].toLowerCase();

                console.log(this.data);

                var xhr = new XMLHttpRequest()
                var self = this
                xhr.open('POST', "http://localhost:8080/" + path, false);
                xhr.setRequestHeader("Content-Type", "application/json");
                xhr.onload = function () {
                }
                xhr.send(JSON.stringify(this.data));

                if(this.eventListeners){
                    this.eventListeners.forEach(function(listenerRef){
                        var listener = self.$root.$refs[listenerRef];

                       if(listener.onEvent){
                           listener.onEvent('saved', self.data);
                       }
                    });
                }
            }

        }

    })


</script>















<!--  ------------------------------------  인스턴스 영역입니다. 분리 예정입니다  -----------------------------------------   -->






<div id="app">
    <form id="search">
        Search <input name="query" v-model="searchQuery">
    </form>
    <object-grid ref="grid"
            :java="java"
            :filter-key="searchQuery"
            :column-changer="columnChanger"
    >
    </object-grid>

    <md-button class="md-fab md-fab-bottom-right" id="fab" @click.native="$refs['dialog'].open()">
        <md-icon>add</md-icon>
    </md-button>

    <md-dialog md-open-from="#fab" md-close-to="#fab" ref="dialog">
        <md-dialog-title>제품 마스터 생성</md-dialog-title>

        <md-dialog-content>
            <object-form ref="object-form"
                    :java="java"
                    :data = "data"
                    :event-listeners = "['grid']"
            >
            </object-form>
        </md-dialog-content>

        <md-dialog-actions>
            <md-button class="md-primary" @click.native="$refs['object-form'].submit_(); $refs['dialog'].close()">저장</md-button>
            <md-button class="md-primary" @click.native="$refs['dialog'].close()">닫기</md-button>
        </md-dialog-actions>
    </md-dialog>

</div>





<script>

    var app = new Vue({
        el: '#app',
        data: {
            java: "com.moornmo.ltms.Product",
            data:
                { curRestNum: 1,  optiNum: 1},
            columnChanger: function(columns){
                columns.push({
                    displayName: '코드',
                    name: 'code',
                    computed: function(item){
                        return item.prodNumber + "-" + item.prodName + "-" + item.prodStandard;
                    }
                })
            }
        }
    })


</script>

</body>
</html>